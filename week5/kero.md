# 클래스 로딩 매커니즘

- 클래스 파일을 메모리로 읽어 들이고 여러가지 과정을 거쳐 jvm에서 사용가능한 자바 타입을 생성하는 과정
- 아래순서로 해당과정이 시작하는것이며, 엄격히 순서가 지켜지진 않는경우가 있다.
### 클래스 로딩 과정
#### 로딩(Loading)
- 로딩단계에서 하는것
	- Fully Qualified Class Name (FQCN)로 바이너리 바이트 스트림 가져오기
	- 바이트 스트림을 사용가능한 데이터 구조로 변환
	- java.lang.Class 객체를 힙에 생성
- 바이너리 바이트 스트림은 다양한 형태로 존재가능
	- 파일, ZIP, 네트워크로부터 가져오기, 디비, 암호화 등...
- \[L으로 시작하는 배열 클래스만 클래스로더가 아닌 jvm이 직접 생성
	- 이것에 대응되는 .class 파일이 없기 떄문이다.
	- FQCN이 없다.
#### 링킹(Linking) - 검증(Verification)
- jvm 명세 규정의 제약을 만족하는지와 보안위협이 있는지 확인하기 위함
- 파일 형식 검증
	- 파일이 가상머신이 처리가능한 형태인지 확인
	- 매직넘버 0xCAFEBABE, 버전, 상수타입, 상수 데이터
- 메타데이터 검증
	- 의미정보를 분석
	- 상위클래스, 상속 사용 가능여부(final), 인터페이스/추상클래스 필수메서드 구현여부 등...
- 바이트코드 검증
	- 메서드 본문이 논리적인지 확인
	- int연산전에 int가아닌 다른타입이 변수에 올라가있는지 확인
	- 바이트코드 밖으로 점프하는 보안위협이 있는지 확인
	- 넓은타입의 객체를 작은타입 변수에 대입하는지 확인
	- 각 바이트코드 라인의 타입을 StackMapTable에 컴파일시점에 저장해서 사용함으로 바이트코드 검증시간을 절약
- 심벌 참조 검증
	- 해석단계에서 수행된다??
		- 검증만하고, 해당 참조를 바꿔주는건 해석단계에서 한다.
	- 해당하는 클래스의 자원들에 접근할 권한이 있는지 확인
#### 링킹(Linking) - 준비(Preperation)
- 클래스 정적 변수를 메모리 할당하고 초기값(항상 0)으로 설정
#### 링킹(Linking) - 해석(Resolution)
- 심벌참조는 클래스, 필드, 메소드를 가리키는 정의
- 심벌참조가 실제 가상머신의 메모리인 직접참조로 변환되는 과정이다.
- 해석되는 시점은 규정이 없어 바로할지, 사용시점에 할지 모른다.
#### 초기화(Initialization)
- 능동참조(active reference): 시작되는 조건
	- 객체생성, 정정필드 읽거나 설정, 정적메서드 호출
	- 리플렉션  메서드로 해당타입사용시
	- 클래스 초기화시 상위클래스 초기화되지 않았을시
	- main()메서드를 포함하는 클래스
	- java.lang.invoke.MethodHandle???
	- 인터페이스의 디폴드 메서드정의시, 인터페이스 구현한 클래스가 초기화 될때
- 수동참조(passive reference): 시작되지 않는 조건
	- 정적변수 참조하였지만 정적변수가 부모클래스에 속할때 -> 부모만 초기화
	- 배열정의시 \[Lorg.example.Test 라는 배열을 담을 별도클래스만 초기화됨
		- 해당 클래스에서는 org.example.Test의 참조값을 담을 공간만 마련해둔다.
	- 상수(static final)사용시 상수풀에 저장되어 상수가 정의된 클래스는 초기화되지 않음
### 클래스 로더
- FQCN 통해서 바이너리를 찾고, 이를 Class 객체로 정의해주는 역할을 함
- 클래스를 같은 클래스 로드로 읽어 들여야만 클래스 동치를 판단가능하다
	- 클래스 로더마다 서로다른 네임스페이스를 보유하고 있음

#### 부모 위임 모델
- 계층
	- jdk8이전: Bootstrap → Extension → Application(System)
	- jdk9이후: Bootstrap → Platform → Application(System)
		- 모듈시스템 도입으로 인한 변경
- 계층에서 담당하는 라이브러리를 로드후 로드가 불가능해지면 하위로 내려가서 로드하게된다.
- bootstrap
	- jdk 구동에 필수 라이브러리
	- 모듈 시스템 분리로 인해 java 하위에 정말 필요한 모듈만 로드하도록 변경되면서 그외 라이브러리는 platform에러 로드
	- java.lang., java.util, java.io. java.time, java.nio, java.math
- platform
	- jdk 구동에 필수는 아님
	- Java 표준 플랫폼 모듈
	- java.sql, java.xml, 등...
- Application
	- 애플리케이션에서 직접 작성한 클래스
### 자바 모듈 시스템
- jdk9버전에서 도입
- 모듈시스템 이전
	- jre가 하나의 모듈로 사용하지 않는 라이브러리까지 모두 포함되어 있어 불필요하게 크다.
	- 내부 의존성관리가 힘들었음
	- 클래스로더가 복잡하게 관리됨
		- extension 클래스로더에서 ext디렉토리에 있는 라이브러리가 항상 Application보다 먼저로드됨
		- extension 는 하나만 로드되어 버전을 공유하게됨 -> 버전충돌해결에 어려움
		- extension 전역에 영향을 미치는 라이브러리로 제어하기 어려움
- 모듈 시스템으로 ext은 폐기되고 platform으로 대체
